[["Preprocessing.html", "Chapter 3 Pre-processing of bulk RNA-seq data 3.1 Read Mapping 3.2 Quality Control 3.3 Gene quantification 3.4 Batch effect removal 3.5 Video demo of RIMA", " Chapter 3 Pre-processing of bulk RNA-seq data In this chapter, we will introduce how we align RNA-seq data, check the data quality, quantify gene expression and handle batch effects across samples. 3.1 Read Mapping 3.1.1 STAR STAR is one of the most common tools used for bulk RNA-seq data alignment to generate transcriptome BAM or genomic BAM output, which can be downloaded at https://github.com/alexdobin/STAR . A tutorial of runing STAR is available at tutorial. Once you have installed STAR, the first step is to create genome index. In our RIMA pipeline, we download the human genome (hg38) STAR index from Genomic Data Commons (GDC) . To run STAR of a paired-end sample: STAR --runThreadN 4 --genomeDir /path/to/index --outReadsUnmapped None --chimSegmentMin 12 #generate Chimeric and circulate alignment --outSAMunmapped Within --outSAMtype BAM SortedByCoordinate --readFilesIn sample_1.fastq.gz sample_2.fastq.gz --readFilesCommand zcat --outFileNamePrefix sample --quantMode TranscriptomeSAM GeneCounts # generate outputs in transcript coordinates and mapped read counts per gene Example outputs: sampleAligned.sortedByCoord.out.bam sampleAligned.toTranscriptome.out.bam sampleReadsPerGene.out.tab sampleChimeric.out.junction sampleLog.final.out Then we use samtools to generate statistics of alignment BAM file: samtools stats sampleAligned.sortedByCoord.out.bam | grep ^SN | cut -f 2- &gt; sample.sorted.bam.stat.txt Example output of BAM summary: raw total sequences: 60589702 filtered sequences: 0 sequences: 60589702 is sorted: 1 1st fragments: 30294851 last fragments: 30294851 reads mapped: 59963698 reads mapped and paired: 59963698 # paired-end technology bit set + both mates mapped reads unmapped: 626004 reads properly paired: 59963698 # proper-pair bit set reads paired: 60589702 # paired-end technology bit set reads duplicated: 0 # PCR or optical duplicate bit set reads MQ0: 110872 # mapped and MQ=0 reads QC failed: 0 non-primary alignments: 3102614 total length: 6058970200 # ignores clipping total first fragment length: 3029485100 # ignores clipping total last fragment length: 3029485100 # ignores clipping bases mapped: 5996369800 # ignores clipping bases mapped (cigar): 5952761135 # more accurate bases trimmed: 0 bases duplicated: 0 mismatches: 0 # from NM fields error rate: 0.000000e+00 # mismatches / bases mapped (cigar) average length: 100 average first fragment length: 100 average last fragment length: 100 maximum length: 100 maximum first fragment length: 100 maximum last fragment length: 100 average quality: 39.7 insert size average: 971.3 insert size standard deviation: 1899.5 inward oriented pairs: 29281286 outward oriented pairs: 700563 pairs with other orientation: 0 pairs on different chromosomes: 0 3.2 Quality Control RseQC is a standard tool for checking the quality of reads alignment, providing principal measurements of RNA-seq data quality. RseQC tutorial is available at here. To reduce running time, we first subsampled the BAM file and use only housekeeping genes for quality check using RseQC. ## Example of subsampling 50% of input alignment samtools view -s 0.5 -b sampleAligned.sortedByCoord.out.bam &gt; sample_downsampling.bam # Extract the alignment of housekeeping gene. bedtools intersect -a sample_downsampling.bam -b housekeeping_refseqGenes.bed &gt; sample_downsampling_housekeeping.bam # index BAM samtools index sample_downsampling_housekeeping.bam &gt; sample_downsampling_housekeeping.bam.bai 3.2.1 Quality metrics Transcript integrity number (TIN) is the most widely used measure RNA integrity, which is the percentage of transcripts that has uniform read coverage across the genome. RseQC calculated the TIN of each transcripts and the median TIN score (medTIN) across all transcripts has is commonly used to indicate the RNA integrity and of each sample. Read distribution summarizes the fraction of reads aligned into different genomic regions, such as exon and intron regions. Gene body coverage shows the RNA-seq read coverage over the gene body. Junction saturation detects the splicing junctions with different resampling percentages of reads to determine if the sequencing depth is sufficient to perform alternative splicing analysis. Samples with low alignment fraction or low integrity or abnormal reads distribution usually have bad quality and should be removed in downstream analysis. 3.3 Gene quantification After the alignment of sequencing reads and quality check, we will quantify the gene or transcript expression from the BAM file.Both Salmon and RSEM are widely used for gene quantification. Salmon conducts fast transcript-level quantification, and RSEM performed both gene-level and transcript-level quantification. Salmon is usually faster and less memory-consuming than RSEM. Both tools generate transcripts per million (TPM), reads per kilobase of exon model per million reads (RPKM) and fragments per kilobase of exon model per million mapped reads (FPKM) expression, which is the normalized gene quantification that removing the effect of different gene length. In addition to TPM, HTSeq quantifies gene expression according to mapped read counts. Both normalized gene expression and read counts can be used for differential expression analysis. 3.4 Batch effect removal Batch effects across samples is easily ignored but worth considering problems for immunotherapy cohort study. It is usually caused by unbalanced experimental design where estimation of group difference, and they are interdependent. To avoid the actual biology variation confounded by batch effect, Limma and Combat are common approaches to correct the batch effects. Limma uses a two-way ANOVA approach, while Combat uses the empirical Bayes approach, which is critical for small batches to avoid over-correction. For large batches, both methods should be similar. The sva R package integrates both methods for batch effect correction. To check whether the batch effect has been removed, principal components analysis (PCA) or unsupervised clustering before and after batch effect removal will be an excellent way to validate. To ensure a solid downstream RNA-seq analysis, it is essential to generate a gene expression profile mitigating the batch effect and group difference from a well-designed study. Example of PCA before and after batch effect between FT and FFPE samples: Figure 3.1: Before(left) and after(right) batch correction with Limma 3.5 Video demo of RIMA RIMA preprocess module demo "]]
